begin
  require 'rspec/core/rake_task'
rescue LoadError
  puts "\nRspec 2 is required. Try this: \n\t`gem install rspec-core rspec-expectations`.\n\n"
  raise
end

vagrant_dir = File.join(File.dirname(__FILE__), 'vagrant')

desc "Deploy a fresh vagrant instance (destroying an existing instance)."
task :deploy do
  cd vagrant_dir do
    sh 'vagrant destroy'
    sh 'vagrant up'
  end
end

desc "Re-provision running instance from local chef cookbooks."
task :reprovision do
  cd vagrant_dir do
    sh 'vagrant provision'
  end
end

task :setup_ssh do
  cd vagrant_dir do
    sh "vagrant ssh_config > vagrant.ssh.config"
    ENV['SSH_OPTIONS'] = "-F #{File.expand_path('vagrant.ssh.config')}"
    ENV['SSH_HOST'] = "vagrant"
  end
end

RSpec::Core::RakeTask.new('system_spec') do |t|
  t.rspec_opts = ["--color", "--format documentation", "--require ./spec_helper.rb"]
  t.pattern = '*_spec.rb'
end
task 'system_spec' => 'setup_ssh'

desc "Run system specs on an existing instance."
task :default => 'system_spec'

desc "Deploy fresh instance and run system specs."
task :full => %w( deploy system_spec )

namespace :ec2 do
  require 'AWS'
  require 'pry'

  task :full do
    with_ec2_instance do |instance|
      sh %(tar czf ../../RapidFTR-chef-repo-test.tgz --directory ../.. chef-repo)
      wait 5, "because otherwise sometimes we can't ssh in just yet"
      sh %(scp #{ENV['SSH_OPTIONS']} ../../RapidFTR-chef-repo-test.tgz #{ENV['SSH_HOST']}:)
      sh %(scp #{ENV['SSH_OPTIONS']} vagrant/localhost.rapidftr.test.crt #{ENV['SSH_HOST']}:)
      sh %(scp #{ENV['SSH_OPTIONS']} vagrant/localhost.rapidftr.test.key #{ENV['SSH_HOST']}:)
      sh %(ssh #{ENV['SSH_OPTIONS']} #{ENV['SSH_HOST']} "tar xzf RapidFTR-chef-repo-test.tgz")
      sh %(ssh #{ENV['SSH_OPTIONS']} #{ENV['SSH_HOST']} "cd chef-repo/ && sudo env SSL_CRT=/home/ubuntu/localhost.rapidftr.test.crt SSL_KEY=/home/ubuntu/localhost.rapidftr.test.key FQDN=#{instance.dnsName} ./setup-ubuntu.sh")
      sh %(ssh #{ENV['SSH_OPTIONS']} #{ENV['SSH_HOST']} "sudo chef-solo")
      Rake::Task['system_spec'].invoke
    end
  end

  task :up_and_down do
    with_ec2_instance do |instance|
      puts "Instance up."
      binding.pry
    end
  end
end

def with_ec2_instance
  key_id, key, id_file = ec2_auth_stuff
  puts key_id, key, id_file
  ec2 = AWS::EC2::Base.new(:access_key_id => key_id, :secret_access_key => key)
  ami = "ami-7000f019" # Ubuntu 10.04 LTS Lucid instance-store from http://alestic.com/
  puts "Launching instance with AMI #{ami}"
  r = ec2.run_instances(
    :image_id => ami,
    :disable_api_termination => false,
    :instance_type => "c1.medium",
    :key_name => File.basename(id_file, '.pem'))
  instance_id = r.instancesSet.item.first.instanceId
  instance = nil
  attempts = 0
  wait 20, "for launch of instance #{instance_id}"
  loop do
    description = ec2.describe_instances(:instance_id => instance_id)
    instance = description.reservationSet.item[0].instancesSet.item[0]
    puts "Instance is #{instance.instanceState.name}"
    break if instance.instanceState.name == "running"
    attempts += 1
    raise "Instance still not running after #{attempts} checks!" if attempts > 20
    wait 8, "for instance #{instance_id} to be running"
  end

  setup_ec2_ssh instance, id_file

  yield instance

rescue Exception => e
  $stderr.puts e
  raise
ensure
  # puts "Going to terminate instance #{instance_id}."; pry
  if ec2
    puts "Terminating instance #{instance_id}."
    ec2.terminate_instances :instance_id => [instance_id]
  else
    puts "EC2 not set up. HOPEFULLY no instance was launched!"
  end
end

def ec2_auth_stuff
  key_id = ENV['AMAZON_ACCESS_KEY_ID']
  key = ENV['AMAZON_SECRET_ACCESS_KEY'] ||
    (ENV['AMAZON_SECRET_ACCESS_KEY_FILE'] && `cat #{ENV['AMAZON_SECRET_ACCESS_KEY_FILE']}`.chomp) ||
    raise("AMAZON_SECRET_ACCESS_KEY or AMAZON_SECRET_ACCESS_KEY_FILE is required")
  id_file = ENV['RAPID_FTR_IDENTITY_FILE']
  [key_id, key, id_file]
end

def setup_ec2_ssh instance, id_file
  File.open('aws.ssh.config', 'w') do |file|
    file.write "Host ec2
      HostName #{instance.dnsName}
      User ubuntu
      UserKnownHostsFile /dev/null
      StrictHostKeyChecking no
      PasswordAuthentication no
      IdentityFile #{File.expand_path(id_file)}
      IdentitiesOnly yes"
    file.puts
  end
  ENV['SSH_OPTIONS'] = "-F #{File.expand_path('aws.ssh.config')}"
  ENV['SSH_HOST'] = "ec2"
end

def wait seconds, reason
  puts "Waiting #{seconds} seconds #{reason}"
  sleep seconds
end
